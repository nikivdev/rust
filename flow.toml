version = 1
name = "rust"

[flow]
primary_task = "deploy"

[[tasks]]
name = "default"
command = """
cat <<'EOF'
Available tasks:
- setup                  Ensure Cargo is installed and download Flow CLI dependencies.
- flow [args...]         Run the Flow CLI (passes CLI args through).
- index [args...]        Run the Index CLI (passes CLI args through).
- dev [args...]          Alias for flow.
- run [args...]          Alias for flow.
- deploy                 Build the Flow CLI binary and install it to ~/bin/flow-rs.
- deploy-ghostty-switch  Install the ghostty-switch helper to ~/bin.
- stream [args...]       Run the Stream CLI (passes CLI args through).
- deploy-stream          Build the Stream CLI binary and install it to ~/bin/stream.
- deploy-stream-server   Build and deploy stream server to Linux host (65.108.248.119).
- code [args...]         Run the Code CLI (passes CLI args through).
- try [args...]          Run the Try CLI (passes CLI args through).
- try-build              Build the Try CLI binary (dev profile).
- deploy-frs             Build the Flow CLI binary and install it to ~/bin/frs.
- claude [args...]       Run the Claude CLI (passes CLI args through).
- deploy-claude          Build the Claude CLI binary and install it to ~/bin/claude-rs.
- mac [args...]          Run the macOS CLI (passes CLI args through).
- deploy-mac             Build the macOS CLI binary and install it to ~/bin/mac.
- km [args...]           Run the Keyboard Maestro CLI (passes CLI args through).
- deploy-km              Build the Keyboard Maestro CLI binary and install it to ~/bin/km.
- karabiner [args...]    Run the Karabiner CLI (passes CLI args through).
- deploy-karabiner       Build the Karabiner CLI binary and install it to ~/bin/karabiner.
- ctx [args...]          Run the Context CLI (passes CLI args through).
- deploy-ctx             Build the Context CLI binary and install it to ~/bin/ctx.
- deploy-personal-mcp    Build the personal MCP server and install it to ~/bin/personal-mcp.
- ax [args...]           Run the Accessibility CLI (passes CLI args through).
- deploy-ax              Build the Accessibility CLI binary and install it to ~/bin/ax.

Streaming (macOS → Linux):
- stream [setup/start/stop/status]  Guided streaming setup and control.

Linux Server (65.108.248.119):
- linux                  SSH or manage Linux server (ssh/status/reboot/top/disk/logs/cleanup).
EOF
"""
description = "List available tasks."

[[tasks]]
name = "setup"
command = """
set -euo pipefail
if ! command -v cargo >/dev/null 2>&1; then
  echo "Rust toolchain 'cargo' not found in PATH."
  echo "Install it via https://www.rust-lang.org/tools/install"
  exit 1
fi
cargo --version >/dev/null
repo_root="$PWD"
export CARGO_HOME="${CARGO_HOME:-$repo_root/.cargo_home}"
export CARGO_TARGET_DIR="${CARGO_TARGET_DIR:-$repo_root/target}"
mkdir -p "$CARGO_HOME"
mkdir -p "$CARGO_TARGET_DIR"
for manifest in "$repo_root/cli/flow/Cargo.toml" "$repo_root/cli/index/Cargo.toml" "$repo_root/cli/code/Cargo.toml" "$repo_root/cli/stream/Cargo.toml" "$repo_root/cli/try/Cargo.toml"; do
  if ! cargo fetch --manifest-path "$manifest" >/dev/null; then
    echo "Warning: unable to download Cargo dependencies for $manifest; try again once network access is available."
  fi
done
echo "you are setup"
"""
description = "Ensure Cargo is installed and download Flow CLI dependencies."

[[tasks]]
name = "flow"
command = """
set -euo pipefail
repo_root="$PWD"
export CARGO_HOME="${CARGO_HOME:-$repo_root/.cargo_home}"
export CARGO_TARGET_DIR="${CARGO_TARGET_DIR:-$repo_root/target}"
mkdir -p "$CARGO_HOME"
mkdir -p "$CARGO_TARGET_DIR"
cargo run --manifest-path "$repo_root/cli/flow/Cargo.toml" -- "$@"
"""
description = "Run the Flow CLI (passes CLI args through)."

[[tasks]]
name = "index"
command = """
set -euo pipefail
repo_root="$PWD"
export CARGO_HOME="${CARGO_HOME:-$repo_root/.cargo_home}"
export CARGO_TARGET_DIR="${CARGO_TARGET_DIR:-$repo_root/target}"
mkdir -p "$CARGO_HOME"
mkdir -p "$CARGO_TARGET_DIR"
cargo run --manifest-path "$repo_root/cli/index/Cargo.toml" -- "$@"
"""
description = "Run the Index CLI (passes CLI args through)."

[[tasks]]
name = "dev"
command = """
set -euo pipefail
repo_root="$PWD"
export CARGO_HOME="${CARGO_HOME:-$repo_root/.cargo_home}"
export CARGO_TARGET_DIR="${CARGO_TARGET_DIR:-$repo_root/target}"
mkdir -p "$CARGO_HOME"
mkdir -p "$CARGO_TARGET_DIR"
cargo run --manifest-path "$repo_root/cli/flow/Cargo.toml" -- "$@"
"""
description = "Alias for flow."

[[tasks]]
name = "run"
command = """
set -euo pipefail
repo_root="$PWD"
export CARGO_HOME="${CARGO_HOME:-$repo_root/.cargo_home}"
export CARGO_TARGET_DIR="${CARGO_TARGET_DIR:-$repo_root/target}"
mkdir -p "$CARGO_HOME"
mkdir -p "$CARGO_TARGET_DIR"
cargo run --manifest-path "$repo_root/cli/flow/Cargo.toml" -- "$@"
"""
description = "Alias for flow."

[[tasks]]
name = "deploy"
command = """
set -euo pipefail
repo_root="$PWD"
bin_dir="$HOME/bin"
bin_artifact="flow"
bin_name="flow-rs"
mkdir -p "$bin_dir"

export CARGO_HOME="${CARGO_HOME:-$repo_root/.cargo_home}"
export CARGO_TARGET_DIR="${CARGO_TARGET_DIR:-$repo_root/target}"
mkdir -p "$CARGO_HOME"
mkdir -p "$CARGO_TARGET_DIR"

cargo build --manifest-path "$repo_root/cli/flow/Cargo.toml" --release
cp "$CARGO_TARGET_DIR/release/$bin_artifact" "$bin_dir/$bin_name"
chmod 755 "$bin_dir/$bin_name"
echo "Installed CLI to $bin_dir/$bin_name"
"""
description = "Build the Flow CLI binary and install it to ~/bin/flow-rs."

[[tasks]]
name = "deploy-ghostty-switch"
command = """
set -euo pipefail
bin_dir="$HOME/bin"
ghostty_switch_name="ghostty-switch"
ghostty_switch_dir="$HOME/config/sh"
mkdir -p "$bin_dir"
install -m 755 "$ghostty_switch_dir/$ghostty_switch_name" "$bin_dir/$ghostty_switch_name"
echo "Installed ghostty-switch to $bin_dir/$ghostty_switch_name"
"""
description = "Install the ghostty-switch helper script to ~/bin/ghostty-switch."

[[tasks]]
name = "stream"
command = """
set -euo pipefail
REMOTE_HOST="root@65.108.248.119"
REMOTE_DIR="/root/stream-server"
ACTION="${1:-menu}"

case "$ACTION" in
  start)
    echo "==> Starting streaming..."
    stream start --skip-remote
    ;;
  stop)
    stream stop
    ;;
  status)
    echo "=== Local ==="
    stream status 2>/dev/null || echo "No local stream"
    echo ""
    echo "=== Remote ==="
    curl -s "http://65.108.248.119:8080/status" 2>/dev/null | python3 -m json.tool || echo "Server not responding"
    ;;
  setup)
    echo "╔══════════════════════════════════════╗"
    echo "║  Stream Setup - macOS → Linux        ║"
    echo "╚══════════════════════════════════════╝"
    echo ""
    echo "==> Step 1/4: Building stream CLI..."
    cargo build --manifest-path "$PWD/cli/stream/Cargo.toml" --release 2>&1 | tail -3
    cp "$PWD/target/release/stream" "$HOME/bin/"
    echo "✓ Stream CLI installed"
    echo ""
    echo "==> Step 2/4: Testing SSH..."
    if ssh -o ConnectTimeout=10 -o BatchMode=yes "$REMOTE_HOST" "echo ok" >/dev/null 2>&1; then
      echo "✓ SSH connection works"
    else
      echo "✗ SSH failed - check connection"
      exit 1
    fi
    echo ""
    echo "==> Step 3/4: Setting up Linux server..."
    ssh "$REMOTE_HOST" "mkdir -p $REMOTE_DIR/src"
    scp -q "$PWD/server/stream/Cargo.toml" "$REMOTE_HOST:$REMOTE_DIR/"
    scp -q "$PWD/server/stream/src/"*.rs "$REMOTE_HOST:$REMOTE_DIR/src/"
    scp -q "$PWD/server/stream/stream-server.service" "$REMOTE_HOST:/etc/systemd/system/"
    echo "✓ Files copied"
    ssh -o ServerAliveInterval=30 "$REMOTE_HOST" '
      source ~/.cargo/env 2>/dev/null || true
      if ! command -v cargo >/dev/null 2>&1; then
        echo "Installing Rust..."
        curl --proto "=https" --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source ~/.cargo/env
      fi
      if ! command -v ffmpeg >/dev/null 2>&1; then
        echo "Installing ffmpeg..."
        apt-get update -qq && apt-get install -y -qq ffmpeg build-essential pkg-config libssl-dev
      fi
      cd /root/stream-server
      echo "Building server..."
      cargo build --release 2>&1 | grep -E "(Compiling stream-server|Finished|error)" || true
      cp target/release/stream-server /usr/local/bin/ 2>/dev/null || true
      mkdir -p /root/stream/segments
      systemctl daemon-reload
      systemctl enable stream-server
      systemctl restart stream-server
    '
    echo "✓ Server deployed"
    echo ""
    echo "==> Step 4/4: Verifying..."
    sleep 2
    if curl -s "http://65.108.248.119:8080/health" >/dev/null 2>&1; then
      echo "✓ Server is running"
    else
      echo "! Server not responding yet (may still be starting)"
    fi
    echo ""
    echo "Setup complete!"
    echo ""
    echo "Next: flow stream start"
    ;;
  *)
    echo "╔══════════════════════════════════════╗"
    echo "║  Stream - macOS → Linux              ║"
    echo "╚══════════════════════════════════════╝"
    echo ""
    echo "Usage: flow stream <command>"
    echo ""
    echo "  setup   Full guided setup (first time)"
    echo "  start   Start streaming"
    echo "  stop    Stop streaming"
    echo "  status  Check status"
    echo ""
    echo "Quick start:"
    echo "  flow stream setup"
    echo "  flow stream start"
    ;;
esac
"""
description = "Streaming setup and control (setup/start/stop/status)."

[[tasks]]
name = "youtube"
command = """
set -euo pipefail
LINUX_HOST="65.108.248.119"
SRT_PORT="6000"
ACTION="${1:-help}"

case "$ACTION" in
  start)
    echo "==> Starting zero-CPU screen capture..."
    echo "    ScreenCaptureKit (GPU) → VideoToolbox (GPU) → Linux"
    echo ""
    stream-capture start "$LINUX_HOST" "$SRT_PORT"
    ;;
  start-ffmpeg)
    echo "==> Starting ffmpeg capture (fallback)..."
    ffmpeg -hide_banner \
      -f avfoundation \
      -capture_cursor 1 \
      -framerate 30 \
      -i "1:0" \
      -c:v h264_videotoolbox \
      -realtime 1 \
      -b:v 4500k \
      -g 60 \
      -c:a aac \
      -b:a 128k \
      -f mpegts \
      "srt://$LINUX_HOST:$SRT_PORT"
    ;;
  test)
    echo "Testing capture (no network)..."
    stream-capture test
    ;;
  status)
    echo "=== Linux Server ==="
    curl -s "http://$LINUX_HOST:8080/status" 2>/dev/null | python3 -m json.tool || echo "Server not responding"
    ;;
  setup)
    echo "==> Setting up YouTube streaming on Linux..."
    echo ""
    echo "1. Get your YouTube stream key from YouTube Studio"
    echo "2. SSH to Linux and set: export YOUTUBE_STREAM_KEY=your-key"
    echo "3. Restart stream-server: systemctl restart stream-server"
    echo ""
    echo "Or set it now:"
    read -p "YouTube Stream Key: " KEY
    if [ -n "$KEY" ]; then
      ssh "root@$LINUX_HOST" "echo 'YOUTUBE_STREAM_KEY=$KEY' >> /etc/environment && systemctl restart stream-server"
      echo "✓ Stream key configured"
    fi
    ;;
  stop)
    echo "Stopping stream on Linux..."
    curl -s "http://$LINUX_HOST:8080/stop" | python3 -m json.tool || true
    ;;
  displays)
    stream-capture displays
    ;;
  *)
    echo "╔══════════════════════════════════════╗"
    echo "║  Zero-CPU Streaming (via Linux)      ║"
    echo "╚══════════════════════════════════════╝"
    echo ""
    echo "Usage: f youtube <command>"
    echo ""
    echo "  start       Stream using native zero-CPU capture"
    echo "  start-ffmpeg  Fallback to ffmpeg capture"
    echo "  test        Test capture locally (no network)"
    echo "  stop        Stop streaming"
    echo "  status      Check Linux server status"
    echo "  setup       Configure YouTube stream key"
    echo "  displays    List available displays"
    echo ""
    echo "Architecture (zero CPU on Mac):"
    echo "  ScreenCaptureKit (GPU) → VideoToolbox (GPU) → UDP → Linux"
    echo ""
    echo "CPU usage on Mac: <1%"
    ;;
esac
"""
description = "Stream to YouTube via Linux with zero Mac CPU usage."

[[tasks]]
name = "code"
command = """
set -euo pipefail
repo_root="$PWD"
export CARGO_HOME="${CARGO_HOME:-$repo_root/.cargo_home}"
export CARGO_TARGET_DIR="${CARGO_TARGET_DIR:-$repo_root/target}"
mkdir -p "$CARGO_HOME"
mkdir -p "$CARGO_TARGET_DIR"
cargo run --manifest-path "$repo_root/cli/code/Cargo.toml" -- "$@"
"""
description = "Run the Code CLI (passes CLI args through)."

[[tasks]]
name = "try"
command = """
set -euo pipefail
repo_root="$PWD"
export CARGO_HOME="${CARGO_HOME:-$repo_root/.cargo_home}"
export CARGO_TARGET_DIR="${CARGO_TARGET_DIR:-$repo_root/target}"
mkdir -p "$CARGO_HOME"
mkdir -p "$CARGO_TARGET_DIR"
cargo run --manifest-path "$repo_root/cli/try/Cargo.toml" -- "$@"
"""
description = "Run the Try CLI (passes CLI args through)."

[[tasks]]
name = "try-build"
command = """
set -euo pipefail
repo_root="$PWD"
export CARGO_HOME="${CARGO_HOME:-$repo_root/.cargo_home}"
export CARGO_TARGET_DIR="${CARGO_TARGET_DIR:-$repo_root/target}"
mkdir -p "$CARGO_HOME"
mkdir -p "$CARGO_TARGET_DIR"
cargo build --manifest-path "$repo_root/cli/try/Cargo.toml"
"""
description = "Build the Try CLI binary (dev profile)."

[[tasks]]
name = "deploy-frs"
command = """
set -euo pipefail
repo_root="$PWD"
bin_dir="$HOME/bin"
bin_artifact="flow"
bin_name="frs"
mkdir -p "$bin_dir"

export CARGO_HOME="${CARGO_HOME:-$repo_root/.cargo_home}"
export CARGO_TARGET_DIR="${CARGO_TARGET_DIR:-$repo_root/target}"
mkdir -p "$CARGO_HOME"
mkdir -p "$CARGO_TARGET_DIR"

cargo build --manifest-path "$repo_root/cli/flow/Cargo.toml" --release
cp "$CARGO_TARGET_DIR/release/$bin_artifact" "$bin_dir/$bin_name"
chmod 755 "$bin_dir/$bin_name"
xattr -c "$bin_dir/$bin_name"
codesign -s - "$bin_dir/$bin_name"
echo "Installed CLI to $bin_dir/$bin_name"
"""
description = "Build the Flow CLI binary and install it to ~/bin/frs."

[[tasks]]
name = "claude"
command = """
set -euo pipefail
repo_root="$PWD"
export CARGO_HOME="${CARGO_HOME:-$repo_root/.cargo_home}"
export CARGO_TARGET_DIR="${CARGO_TARGET_DIR:-$repo_root/target}"
mkdir -p "$CARGO_HOME"
mkdir -p "$CARGO_TARGET_DIR"
cargo run --manifest-path "$repo_root/cli/claude/Cargo.toml" -- "$@"
"""
description = "Run the Claude CLI (passes CLI args through)."

[[tasks]]
name = "deploy-claude"
command = """
set -euo pipefail
repo_root="$PWD"
bin_dir="$HOME/bin"
bin_artifact="claude-rs"
bin_name="claude-rs"
mkdir -p "$bin_dir"

export CARGO_HOME="${CARGO_HOME:-$repo_root/.cargo_home}"
export CARGO_TARGET_DIR="${CARGO_TARGET_DIR:-$repo_root/target}"
mkdir -p "$CARGO_HOME"
mkdir -p "$CARGO_TARGET_DIR"

cargo build --manifest-path "$repo_root/cli/claude/Cargo.toml" --release
cp "$CARGO_TARGET_DIR/release/$bin_artifact" "$bin_dir/$bin_name"
chmod 755 "$bin_dir/$bin_name"
echo "Installed CLI to $bin_dir/$bin_name"
"""
description = "Build the Claude CLI binary and install it to ~/bin/claude-rs."

[[tasks]]
name = "mac"
command = """
set -euo pipefail
repo_root="$PWD"
export CARGO_HOME="${CARGO_HOME:-$repo_root/.cargo_home}"
export CARGO_TARGET_DIR="${CARGO_TARGET_DIR:-$repo_root/target}"
mkdir -p "$CARGO_HOME"
mkdir -p "$CARGO_TARGET_DIR"
cargo run --manifest-path "$repo_root/cli/mac/Cargo.toml" -- "$@"
"""
description = "Run the macOS CLI (passes CLI args through)."

[[tasks]]
name = "deploy-mac"
command = """
set -euo pipefail
repo_root="$PWD"
bin_dir="$HOME/bin"
bin_artifact="macos"
bin_name="mac"
mkdir -p "$bin_dir"

export CARGO_HOME="${CARGO_HOME:-$repo_root/.cargo_home}"
export CARGO_TARGET_DIR="${CARGO_TARGET_DIR:-$repo_root/target}"
mkdir -p "$CARGO_HOME"
mkdir -p "$CARGO_TARGET_DIR"

cargo build --manifest-path "$repo_root/cli/mac/Cargo.toml" --release
cp "$CARGO_TARGET_DIR/release/$bin_artifact" "$bin_dir/$bin_name"
chmod 755 "$bin_dir/$bin_name"
echo "Installed CLI to $bin_dir/$bin_name"
"""
description = "Build the macOS CLI binary and install it to ~/bin/mac."

[[tasks]]
name = "km"
command = """
set -euo pipefail
repo_root="$PWD"
export CARGO_HOME="${CARGO_HOME:-$repo_root/.cargo_home}"
export CARGO_TARGET_DIR="${CARGO_TARGET_DIR:-$repo_root/target}"
mkdir -p "$CARGO_HOME"
mkdir -p "$CARGO_TARGET_DIR"
cargo run --manifest-path "$repo_root/cli/km/Cargo.toml" -- "$@"
"""
description = "Run the Keyboard Maestro CLI (passes CLI args through)."

[[tasks]]
name = "deploy-km"
command = """
set -euo pipefail
repo_root="$PWD"
bin_dir="$HOME/bin"
bin_artifact="km"
bin_name="km"
mkdir -p "$bin_dir"

export CARGO_HOME="${CARGO_HOME:-$repo_root/.cargo_home}"
export CARGO_TARGET_DIR="${CARGO_TARGET_DIR:-$repo_root/target}"
mkdir -p "$CARGO_HOME"
mkdir -p "$CARGO_TARGET_DIR"

cargo build --manifest-path "$repo_root/cli/km/Cargo.toml" --release
cp "$CARGO_TARGET_DIR/release/$bin_artifact" "$bin_dir/$bin_name"
chmod 755 "$bin_dir/$bin_name"
echo "Installed CLI to $bin_dir/$bin_name"
"""
description = "Build the Keyboard Maestro CLI binary and install it to ~/bin/km."

[[tasks]]
name = "karabiner"
command = """
set -euo pipefail
repo_root="$PWD"
export CARGO_HOME="${CARGO_HOME:-$repo_root/.cargo_home}"
export CARGO_TARGET_DIR="${CARGO_TARGET_DIR:-$repo_root/target}"
mkdir -p "$CARGO_HOME"
mkdir -p "$CARGO_TARGET_DIR"
cargo run --manifest-path "$repo_root/cli/karabiner/Cargo.toml" -- "$@"
"""
description = "Run the Karabiner CLI (passes CLI args through)."

[[tasks]]
name = "deploy-karabiner"
command = """
set -euo pipefail
repo_root="$PWD"
bin_dir="$HOME/bin"
bin_artifact="karabiner"
bin_name="karabiner"
mkdir -p "$bin_dir"

export CARGO_HOME="${CARGO_HOME:-$repo_root/.cargo_home}"
export CARGO_TARGET_DIR="${CARGO_TARGET_DIR:-$repo_root/target}"
mkdir -p "$CARGO_HOME"
mkdir -p "$CARGO_TARGET_DIR"

cargo build --manifest-path "$repo_root/cli/karabiner/Cargo.toml" --release
cp "$CARGO_TARGET_DIR/release/$bin_artifact" "$bin_dir/$bin_name"
chmod 755 "$bin_dir/$bin_name"
echo "Installed CLI to $bin_dir/$bin_name"
"""
description = "Build the Karabiner CLI binary and install it to ~/bin/karabiner."

[[tasks]]
name = "ctx"
command = """
set -euo pipefail
repo_root="$PWD"
export CARGO_HOME="${CARGO_HOME:-$repo_root/.cargo_home}"
export CARGO_TARGET_DIR="${CARGO_TARGET_DIR:-$repo_root/target}"
mkdir -p "$CARGO_HOME"
mkdir -p "$CARGO_TARGET_DIR"
cargo run --manifest-path "$repo_root/cli/ctx/Cargo.toml" -- "$@"
"""
description = "Run the Context CLI (passes CLI args through)."

[[tasks]]
name = "deploy-ctx"
command = """
set -euo pipefail
repo_root="$PWD"
bin_dir="$HOME/bin"
bin_artifact="ctx"
bin_name="ctx"
mkdir -p "$bin_dir"

export CARGO_HOME="${CARGO_HOME:-$repo_root/.cargo_home}"
export CARGO_TARGET_DIR="${CARGO_TARGET_DIR:-$repo_root/target}"
mkdir -p "$CARGO_HOME"
mkdir -p "$CARGO_TARGET_DIR"

cargo build --manifest-path "$repo_root/cli/ctx/Cargo.toml" --release
cp "$CARGO_TARGET_DIR/release/$bin_artifact" "$bin_dir/$bin_name"
chmod 755 "$bin_dir/$bin_name"
echo "Installed CLI to $bin_dir/$bin_name"
"""
description = "Build the Context CLI binary and install it to ~/bin/ctx."

[[tasks]]
name = "deploy-personal-mcp"
command = """
set -euo pipefail
repo_root="$PWD"
bin_dir="$HOME/bin"
bin_artifact="personal-mcp"
bin_name="personal-mcp"
mkdir -p "$bin_dir"

export CARGO_HOME="${CARGO_HOME:-$repo_root/.cargo_home}"
export CARGO_TARGET_DIR="${CARGO_TARGET_DIR:-$repo_root/target}"
mkdir -p "$CARGO_HOME"
mkdir -p "$CARGO_TARGET_DIR"

cargo build --manifest-path "$repo_root/cli/personal-mcp/Cargo.toml" --release
cp "$CARGO_TARGET_DIR/release/$bin_artifact" "$bin_dir/$bin_name"
chmod 755 "$bin_dir/$bin_name"
echo "Installed CLI to $bin_dir/$bin_name"
"""
description = "Build the personal MCP server and install it to ~/bin/personal-mcp."

[[tasks]]
name = "ax"
command = """
set -euo pipefail
repo_root="$PWD"
export CARGO_HOME="${CARGO_HOME:-$repo_root/.cargo_home}"
export CARGO_TARGET_DIR="${CARGO_TARGET_DIR:-$repo_root/target}"
mkdir -p "$CARGO_HOME"
mkdir -p "$CARGO_TARGET_DIR"
cargo run --manifest-path "$repo_root/cli/ax/Cargo.toml" -- "$@"
"""
description = "Run the Accessibility CLI (passes CLI args through)."

[[tasks]]
name = "deploy-ax"
command = """
set -euo pipefail
repo_root="$PWD"
bin_dir="$HOME/bin"
bin_artifact="ax"
bin_name="ax"
mkdir -p "$bin_dir"

export CARGO_HOME="${CARGO_HOME:-$repo_root/.cargo_home}"
export CARGO_TARGET_DIR="${CARGO_TARGET_DIR:-$repo_root/target}"
mkdir -p "$CARGO_HOME"
mkdir -p "$CARGO_TARGET_DIR"

cargo build --manifest-path "$repo_root/cli/ax/Cargo.toml" --release
cp "$CARGO_TARGET_DIR/release/$bin_artifact" "$bin_dir/$bin_name"
chmod 755 "$bin_dir/$bin_name"
echo "Installed CLI to $bin_dir/$bin_name"
"""
description = "Build the Accessibility CLI binary and install it to ~/bin/ax."

[[tasks]]
name = "deploy-observe"
command = """
set -euo pipefail
repo_root="$PWD"
bin_dir="$HOME/bin"
bin_artifact="observe"
bin_name="observe"
mkdir -p "$bin_dir"

export CARGO_HOME="${CARGO_HOME:-$repo_root/.cargo_home}"
export CARGO_TARGET_DIR="${CARGO_TARGET_DIR:-$repo_root/target}"
mkdir -p "$CARGO_HOME"
mkdir -p "$CARGO_TARGET_DIR"

cargo build --manifest-path "$repo_root/cli/observe/Cargo.toml" --release
cp "$CARGO_TARGET_DIR/release/$bin_artifact" "$bin_dir/$bin_name"
chmod 755 "$bin_dir/$bin_name"
echo "Installed CLI to $bin_dir/$bin_name"
"""
description = "Build the Observe CLI binary and install it to ~/bin/observe."

[[tasks]]
name = "deploy-stream-server"
command = """
set -euo pipefail
REMOTE_HOST="root@65.108.248.119"
REMOTE_DIR="/root/stream-server"

echo "=== Step 1: Creating remote directory ==="
ssh -o ConnectTimeout=30 "$REMOTE_HOST" "mkdir -p $REMOTE_DIR/src"

echo "=== Step 2: Copying source files ==="
scp "$PWD/server/stream/Cargo.toml" "$REMOTE_HOST:$REMOTE_DIR/"
scp "$PWD/server/stream/src/main.rs" "$REMOTE_HOST:$REMOTE_DIR/src/"
scp "$PWD/server/stream/src/receiver.rs" "$REMOTE_HOST:$REMOTE_DIR/src/"
scp "$PWD/server/stream/src/s3.rs" "$REMOTE_HOST:$REMOTE_DIR/src/"
scp "$PWD/server/stream/src/watcher.rs" "$REMOTE_HOST:$REMOTE_DIR/src/"
scp "$PWD/server/stream/stream-server.service" "$REMOTE_HOST:/etc/systemd/system/"

echo "=== Step 3: Installing dependencies and building (this takes a few minutes) ==="
ssh -o ServerAliveInterval=60 "$REMOTE_HOST" "
  set -euo pipefail

  # Install build tools if needed
  if ! command -v gcc >/dev/null 2>&1; then
    echo 'Installing build tools...'
    apt-get update -qq && apt-get install -y -qq build-essential pkg-config libssl-dev
  fi

  # Install Rust if not present
  if ! command -v cargo >/dev/null 2>&1; then
    echo 'Installing Rust...'
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  fi
  source ~/.cargo/env 2>/dev/null || true

  # Install ffmpeg if not present
  if ! command -v ffmpeg >/dev/null 2>&1; then
    echo 'Installing ffmpeg...'
    apt-get update -qq && apt-get install -y -qq ffmpeg
  fi

  # Build
  cd $REMOTE_DIR
  echo 'Building stream-server (this may take a few minutes)...'
  cargo build --release 2>&1

  # Install
  cp target/release/stream-server /usr/local/bin/
  chmod 755 /usr/local/bin/stream-server

  # Create directories
  mkdir -p /root/stream/segments

  # Setup systemd service
  systemctl daemon-reload
  systemctl enable stream-server
  systemctl restart stream-server

  echo ''
  echo '=== Stream server deployed and started ==='
  systemctl status stream-server --no-pager || true
"
"""
description = "Build and deploy stream server to Linux host (65.108.248.119)."

# ============================================================================
# Linux Server Management (65.108.248.119)
# ============================================================================

[[tasks]]
name = "linux"
command = """
set -euo pipefail
REMOTE="root@65.108.248.119"
ACTION="${1:-ssh}"

case "$ACTION" in
  ssh|shell)
    ssh "$REMOTE"
    ;;
  status)
    ssh -o ConnectTimeout=10 "$REMOTE" '
      echo "=== System ===" && uname -n && uptime
      echo "" && echo "=== Memory ===" && free -h | head -2
      echo "" && echo "=== Disk ===" && df -h / | tail -1
      echo "" && echo "=== Services ==="
      systemctl is-active stream-server 2>/dev/null && echo "stream-server: running" || echo "stream-server: stopped"
    '
    ;;
  reboot)
    echo "Rebooting..."
    ssh -o ConnectTimeout=10 "$REMOTE" "reboot" || true
    echo "Waiting 30s..."
    sleep 30
    ssh -o ConnectTimeout=30 "$REMOTE" "uptime" && echo "Server is back!"
    ;;
  top)
    ssh -t "$REMOTE" "htop 2>/dev/null || top"
    ;;
  disk)
    ssh -o ConnectTimeout=10 "$REMOTE" '
      df -h
      echo "" && echo "=== Largest in /root ==="
      du -sh /root/* 2>/dev/null | sort -hr | head -5
    '
    ;;
  logs)
    ssh -o ConnectTimeout=10 "$REMOTE" "journalctl -n 50 --no-pager"
    ;;
  cleanup)
    ssh -o ConnectTimeout=10 "$REMOTE" '
      apt-get autoremove -y -qq
      apt-get clean
      find /root/stream/segments -name "*.ts" -mtime +1 -delete 2>/dev/null || true
      echo "Cleanup done" && df -h /
    '
    ;;
  install)
    PKG="${2:-}"
    if [ -z "$PKG" ]; then
      echo "Usage: flow linux install <package>"
      exit 1
    fi
    ssh -o ConnectTimeout=10 "$REMOTE" "apt-get update -qq && apt-get install -y $PKG"
    ;;
  *)
    echo "╔══════════════════════════════════════╗"
    echo "║  Linux Server (65.108.248.119)       ║"
    echo "╚══════════════════════════════════════╝"
    echo ""
    echo "Usage: flow linux <command>"
    echo ""
    echo "  ssh          SSH into server (default)"
    echo "  status       Check health"
    echo "  reboot       Reboot server"
    echo "  top          Process monitor"
    echo "  disk         Disk usage"
    echo "  logs         System logs"
    echo "  cleanup      Clean disk space"
    echo "  install pkg  Install package"
    ;;
esac
"""
description = "Linux server management (ssh/status/reboot/top/disk/logs/cleanup)."

# ============================================================================
# Intent & Sometime Daemons
# ============================================================================

[[tasks]]
name = "intent"
command = """
set -euo pipefail
repo_root="$PWD"
export CARGO_HOME="${CARGO_HOME:-$repo_root/.cargo_home}"
export CARGO_TARGET_DIR="${CARGO_TARGET_DIR:-$repo_root/target}"
mkdir -p "$CARGO_HOME"
mkdir -p "$CARGO_TARGET_DIR"
cargo run --manifest-path "$repo_root/cli/intent/Cargo.toml" -- "$@"
"""
description = "Run the Intent CLI (context-aware action daemon)."

[[tasks]]
name = "commitWithCheck"
command = """
set -euo pipefail
repo_root="$PWD"
export CARGO_HOME="${CARGO_HOME:-$repo_root/.cargo_home}"
export CARGO_TARGET_DIR="${CARGO_TARGET_DIR:-$repo_root/target}"

echo "==> Running cargo check..."
if ! cargo check --workspace 2>&1; then
  echo "❌ cargo check failed"
  exit 1
fi
echo "✓ cargo check passed"

echo ""
echo "==> Committing..."
git add -A
git commit -m "${1:-Update}"
echo "✓ Committed"
"""
description = "Run cargo check, then commit if it passes."

[[tasks]]
name = "deploy-intent"
command = """
set -euo pipefail
repo_root="$PWD"
bin_dir="$HOME/bin"
bin_artifact="intent"
bin_name="intent"
mkdir -p "$bin_dir"

export CARGO_HOME="${CARGO_HOME:-$repo_root/.cargo_home}"
export CARGO_TARGET_DIR="${CARGO_TARGET_DIR:-$repo_root/target}"
mkdir -p "$CARGO_HOME"
mkdir -p "$CARGO_TARGET_DIR"

cargo build --manifest-path "$repo_root/cli/intent/Cargo.toml" --release
cp "$CARGO_TARGET_DIR/release/$bin_artifact" "$bin_dir/$bin_name"
chmod 755 "$bin_dir/$bin_name"
echo "Installed CLI to $bin_dir/$bin_name"
"""
description = "Build the Intent CLI binary and install it to ~/bin/intent."

